# Analyse d'écart MVP – OfflineHQASR

Cette note synthétise l'état réel du code (commit courant) face aux exigences du MVP décrites dans `docs/PRODUCT_REQUIREMENTS.md`. Elle met en évidence ce qui est déjà opérationnel, ce qui reste partiel et les actions à planifier pour sécuriser la release.

## 1. Couverture actuelle vs exigences

| Domaine | Statut | Constats |
| --- | --- | --- |
| **Enregistrement & sélection micro** | Partiel | Le service de premier plan ouvre `AudioRecord` en 48 kHz 16-bit, choisit la source privilégiée (USB/filaire/Bluetooth/interne) et diffuse l'état du micro vers l'UI.【F:app/src/main/java/com/example/offlinehqasr/recorder/RecordService.kt†L46-L160】【F:app/src/main/java/com/example/offlinehqasr/recorder/AudioDeviceSelector.kt†L16-L68】【F:app/src/main/java/com/example/offlinehqasr/ui/MainActivity.kt†L59-L121】 L'application ne réagit toutefois pas aux changements de périphérique en cours d'enregistrement et reste limitée à la détection d'erreurs/silence.【F:docs/PRODUCT_REQUIREMENTS.md†L21-L27】 |
| **Pré-traitement audio** | Partiel | Le `AudioPreprocessor` applique une normalisation heuristique et un « noise gate » mais ne consomme aucun modèle RNNoise/ONNX malgré l'exigence d'un débruitage dédié.【F:app/src/main/java/com/example/offlinehqasr/recorder/AudioPreprocessor.kt†L13-L68】【F:docs/PRODUCT_REQUIREMENTS.md†L21-L27】 |
| **Transcription (Vosk)** | Partiel | La boucle Vosk fonctionne et produit des segments avec timestamps, orchestrée par WorkManager, mais ne fait pas de fenêtrage long terme ni de métriques SLA 60'→30'.【F:app/src/main/java/com/example/offlinehqasr/recorder/VoskEngine.kt†L19-L91】【F:app/src/main/java/com/example/offlinehqasr/recorder/TranscribeWork.kt†L18-L49】【F:docs/PRODUCT_REQUIREMENTS.md†L28-L34】 |
| **Whisper** | Manquant | `WhisperEngine` est un stub qui lève `UnsupportedOperationException`, donc le moteur Whisper requis pour la qualité maximale n'est pas disponible.【F:app/src/main/java/com/example/offlinehqasr/recorder/WhisperEngine.kt†L7-L22】【F:docs/PRODUCT_REQUIREMENTS.md†L16-L18】 |
| **Résumé structuré** | Manquant | Le `Summarizer` renvoie un JSON minimal (titre, contexte, bullets, topics, keywords) sans actions, décisions, sentiments, participants ni timings exigés pour le MVP.【F:app/src/main/java/com/example/offlinehqasr/summary/Summarizer.kt†L26-L48】【F:docs/PRODUCT_REQUIREMENTS.md†L35-L38】 |
| **Stockage & sécurité** | Manquant | Les WAV sont écrits en clair sur le stockage interne et Room ouvre `app.db` sans SQLCipher, contrairement au chiffrement AES-GCM/Keystore demandé. Les exports Markdown/JSON sont également non chiffrés.【F:app/src/main/java/com/example/offlinehqasr/recorder/RecordService.kt†L122-L159】【F:app/src/main/java/com/example/offlinehqasr/data/AppDb.kt†L11-L25】【F:app/src/main/java/com/example/offlinehqasr/export/ExportUtils.kt†L49-L95】【F:docs/PRODUCT_REQUIREMENTS.md†L49-L54】 |
| **Recherche & organisation** | Manquant | Aucune table FTS/virtual table n'est déclarée et la liste d'accueil ne propose ni champ de recherche ni filtres (date, durée, tags, participants) exigés.【F:app/src/main/java/com/example/offlinehqasr/data/AppDb.kt†L11-L25】【F:app/src/main/java/com/example/offlinehqasr/data/Dao.kt†L6-L45】【F:app/src/main/java/com/example/offlinehqasr/ui/MainActivity.kt†L59-L200】【F:docs/PRODUCT_REQUIREMENTS.md†L42-L47】 |
| **Gestion des modèles & erreurs** | Partiel | L'import via SAF gère la copie/décompression Vosk/Whisper, mais sans checksum, rollback ni retour d'avancement; les échecs WorkManager/micro ne sont pas archivés pour relance utilisateur.【F:app/src/main/java/com/example/offlinehqasr/export/ExportUtils.kt†L98-L189】【F:app/src/main/java/com/example/offlinehqasr/recorder/TranscribeWork.kt†L18-L49】【F:docs/PRODUCT_REQUIREMENTS.md†L57-L62】 |
| **Qualité & tests** | Manquant | `TESTING.md` ne couvre que quelques checks manuels et aucune instrumentation/mesure WER/ROUGE n'est scriptée contrairement aux scénarios imposés.【F:TESTING.md†L1-L14】【F:docs/PRODUCT_REQUIREMENTS.md†L63-L68】 |

## 2. Actions critiques à clôturer pour le MVP

1. **Sécuriser tous les artefacts audio** : introduire une couche de chiffrement AES-GCM pilotée par des clés Keystore non exportables pour les WAV, exports et métadonnées, et migrer Room vers SQLCipher ou équivalent.【F:docs/PRODUCT_REQUIREMENTS.md†L49-L54】【F:app/src/main/java/com/example/offlinehqasr/recorder/RecordService.kt†L122-L159】【F:app/src/main/java/com/example/offlinehqasr/data/AppDb.kt†L11-L25】【F:app/src/main/java/com/example/offlinehqasr/export/ExportUtils.kt†L49-L95】
2. **Livrer le résumé JSON complet** : intégrer un LLM local (3–4B) ou un moteur structurant équivalent pour générer actions, décisions, citations, sentiments, participants, tags, keywords et timings, avec fallback explicite si le modèle manque.【F:docs/PRODUCT_REQUIREMENTS.md†L35-L38】【F:app/src/main/java/com/example/offlinehqasr/summary/Summarizer.kt†L26-L48】
3. **Activer la recherche plein texte & les filtres** : ajouter une table FTS5 synchronisée, exposer des requêtes `MATCH` et enrichir l'UI principale avec recherche, tri et filtres requis (date, durée, tags, participants).【F:docs/PRODUCT_REQUIREMENTS.md†L42-L47】【F:app/src/main/java/com/example/offlinehqasr/data/AppDb.kt†L11-L25】【F:app/src/main/java/com/example/offlinehqasr/data/Dao.kt†L6-L45】【F:app/src/main/java/com/example/offlinehqasr/ui/MainActivity.kt†L59-L200】
4. **Remplacer le stub Whisper** : brancher whisper.cpp via JNI (ou wrapper équivalent) avec sélection de modèle large-v3/medium quantifié et gestion mémoire/fallback pour respecter la cible qualité.【F:docs/PRODUCT_REQUIREMENTS.md†L16-L18】【F:app/src/main/java/com/example/offlinehqasr/recorder/WhisperEngine.kt†L7-L22】
5. **Finaliser le pipeline audio** : compléter la chaîne de traitement avec RNNoise/ONNX réel, détection de rupture (périphérique, permissions, Bluetooth) et métriques de niveau (SNR) pour préparer l'écran qualité.【F:docs/PRODUCT_REQUIREMENTS.md†L21-L27】【F:app/src/main/java/com/example/offlinehqasr/recorder/RecordService.kt†L81-L160】【F:app/src/main/java/com/example/offlinehqasr/recorder/AudioPreprocessor.kt†L13-L68】
6. **Renforcer la transcription longue durée** : implémenter fenêtrage/reprise de contexte, journaliser la durée de traitement et stocker les métriques SLA 60'→30' en base pour affichage et QA.【F:docs/PRODUCT_REQUIREMENTS.md†L28-L34】【F:app/src/main/java/com/example/offlinehqasr/recorder/VoskEngine.kt†L19-L91】【F:app/src/main/java/com/example/offlinehqasr/recorder/TranscribeWork.kt†L18-L49】
7. **Fiabiliser l'import modèles & la gestion d'erreurs** : ajouter validation d'intégrité, progression UI, rollback et journal d'échecs WorkManager/micro afin que l'utilisateur puisse relancer les jobs sans ambiguïté.【F:docs/PRODUCT_REQUIREMENTS.md†L57-L62】【F:app/src/main/java/com/example/offlinehqasr/export/ExportUtils.kt†L98-L189】【F:app/src/main/java/com/example/offlinehqasr/recorder/TranscribeWork.kt†L18-L49】
8. **Industrialiser les tests** : enrichir `TESTING.md`, ajouter des tests instrumentés/unitaires couvrant perte de micro, bascule Bluetooth, corruption de modèle, chiffrement, validation du JSON de résumé et pipeline WorkManager.【F:docs/PRODUCT_REQUIREMENTS.md†L63-L68】【F:TESTING.md†L1-L14】

## 3. Piste d'améliorations post-MVP

- **Mode arrière-plan avancé & throttling thermique**, **audit trail détaillé**, **partage local chiffré** et **intégrations Nextcloud** restent alignés avec la phase 2 décrite dans les exigences et pourront être planifiés après la stabilisation du MVP.【F:docs/PRODUCT_REQUIREMENTS.md†L10-L19】【F:docs/PRODUCT_REQUIREMENTS.md†L49-L55】【F:docs/PRODUCT_REQUIREMENTS.md†L77-L82】
- **Vue chapitres/intervenants, entités métier, multilingue et UI projets** restent hors périmètre immédiat mais doivent être gardés dans la roadmap V2+.【F:docs/PRODUCT_REQUIREMENTS.md†L35-L47】
